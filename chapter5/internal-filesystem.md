#文件系统


### 磁盘分区
要了解文件系统，首先我们需要了解一下磁盘分区的基本知识，学习到这些之后，我们将能学习如何完成常见的分区操作

首先，以Windows系统为例，我们的计算机一般总是拥有一块或多块存储设备，不论是机械硬盘还是固态硬盘，甚至是移动硬盘和U盘，用来保存大多数的数据，为了避免歧义(因为Windows系统中会将这两个概念进行一定程度的混淆)，我们统一在这里称上述设备为磁盘(Disk)。在这个Disk上面，存在很多的分区(Partition)，如C盘，D盘,F盘等。他们是怎么组织的呢，我们可以通过Windows的内置的设备管理器来获得一个基本的认知。

##TODO : Add a pic

如上图所示， TODO : Add more description

实际上，我们刚买来的磁盘(Disk)如同一张白纸，上面没有信息

|                          |

而分区的作用就是将磁盘划分为几个不同的区域，用来做不同的用途，比如C盘用来存系统，D盘用来存放软件。这些分区规划的信息记录将被写在磁盘的最开头，我们称之为分区表（上根据分区表的不同，分区表内还会有其他信息，如MBR记录，将在之后讲到）。分区表会记录每一个分区拥有磁盘上的哪一块区域，如仅仅记录开始和结束位置。分区之后大致如下，在这里我们假设分了3个分区，给他们分配盘符C,D,F之后就成了我们常说的C盘,D盘,F盘（Windows称之为本地磁盘C,D,F，实际上是一个分区）

|分区表| 分区1 | 分区2 | 分区3 |

> 由于Windows系统只会识别U盘设备的一个分区,所以插入一个U盘(Disk)时看起来只像插入了一个分区(Partition)，在逻辑上U盘设备和普通硬盘仍然是一样的

> 从安全的角度思考，如果我们擦除了分区表那一部分的内容，分区信息消失，我们也就不知道每个分区在哪里了，那么整个系统也会无法启动，CIH病毒的破坏机制中就有用到类似的原理。现在通用的分区表如GPT分区表为了安全起见，也有采取在硬盘尾部备份分区表的措施，从而防止意外。


## 文件系统
Windows提供了一个格式化的功能(Format)，常被用于"删除"U盘上的所有数据，那么格式化(一般指快速格式化)功能真的删除了这些数据么?EasyRecovery这类数据恢复软件能找到被删除的文件又是什么原理呢？


格式化功能是针对分区(Partition)而言的，分区在创建后只有在格式化之后才能被使用，我们在格式化的时候会很关注的一个选项是文件系统。如常见的U盘分区一般都被格式化为FAT32文件系统，C盘等这些盘会被格式化为NTFS文件系统，这些文件系统是什么呢？

我们在分完区后，分区本身也是一张白纸，如下图所示:

## TODO : Add a pic

为了更有效率地存放文件，我们规定了一个文件系统的概念，文件系统一般包含两部分，即索引(Index)和内容。

- **索引**将表明文件的名称，以及一些基本的文件信息（属性等)，以及存放在哪个位置,本身并不存放文件具体内容

- **内容** 存放文件的实际内容

想象一下，如果没有索引，我们寻找每一个文件都有可能从分区的开头找到结尾，寻找需要的时间和这个分区的大小是成正比的[O(n)]。当使用索引的时候，我们将只在这个索引里面寻找需要的文件，索引相对于文件内容而言一般是很小的，而且索引以树的结构被保存，遍历将花费更短的时间。


### "删除"

而删除文件时，一般为了加快速度，我们会直接把文件的索引擦除掉，而不再擦除内容，所以也就无法找到文件的具体位置，也就无法通过常规方式访问文件了。于是，我们通过宣称文件不存在，就达到了删除文件的目的。

而Windows下面的回收站，也并不是真正的删除，他通过把删除的文件移动到一个特殊的目录下，对普通用户不可见，就可以快速删除和恢复文件了。只有在清空回收站的时候，我们才能读取到这里的数据。

因此，格式化的过程可以只初始化好文件系统的索引部分，同样的道理因为不知道了这些文件的位置，我们也就无法直接读取到他们。

> 我们引入一个***擦除***的概念，刚买来的硬盘虽然被比作一张白纸，但是纸上面是写满了东西的。也就是说，这并不代表硬盘上面是没有数据的，硬盘上面可能布满了无意义的0和1。但是，我们认为杂乱无章的信息是没用的，只有被使用的数据是有用的,其余的都是硬盘未被利用的部分。




### "数据恢复"
有了上面的基础，我们就可以大概推出数据恢复软件的基本原理了：通过遍历磁盘，从文件内容部分匹配出特定的文件模式，从而达到恢复文件内容的目的。由于要遍历整个分区，所以文件恢复的过程一般都比较耗时。

然而，并非所有文件的内容都可以被恢复，这是由于文件被删除后，对应的内容区虽然没有被删除，但是这一部分被"释放"了，因为索引被删除后，这里就被表明是“没有”文件的了，后续文件也就可以被存放在这个位置，当被覆盖之后，数据恢复也就基本不太可能了(实际上还有更高成本的数据恢复方式，当然这是硬件相关的)。

因而，当意识到数据被删除后，尽量不要对这个分区进行任何的写操作，防止需要被恢复的文件被覆盖。在很多专业恢复机构，他们会直接对硬盘进行拷贝（没有任何写操作)，进而从副本中恢复数据，防止数据被二次损伤。

常见的数据恢复软件有EasyRecovery, PhotoRec, Foremost等等

> 在电影中，黑客一般被抓住前都会烧毁硬盘，或者擦除硬盘，是为了对抗取证分析的磁盘取证技术，一般会使用类似Encase等软件中来提取硬盘中的一些信息，来找出可能的证据。

### 磁盘碎片